// Sir Trevor, v0.1.3

(function(e,t){function o(e){var n={};return t.each(e,function(r,i){n[t.isArray(e)?r:i]=!0}),n}function u(e){e.preventDefault(),e.stopPropagation()}function a(e){return e.which==17||e.which==224}function f(e,t,n){var r=e.offset().left-t,i=e.offset().top-t,s=r+e.width()+2*t,o=i+e.height()+2*t,u=n.pageX,a=n.pageY;return u>r&&u<s&&a>i&&a<o}function p(e){return e.toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"-")}var n=this,r;r=n.SirTrevor={},r.DEBUG=!1,r.SKIP_VALIDATION=!1,r.DEFAULTS={baseCSSClass:"sir-trevor",errorClass:"error",defaultType:"Text",spinner:{className:"spinner",lines:9,length:8,width:3,radius:6,color:"#000",speed:1.4,trail:57,shadow:!1,left:"50%",top:"50%"},marker:{baseCSSClass:"marker",buttonClass:"button",addText:"Click to add:",dropText:"Drop to place content"},formatBar:{baseCSSClass:"formatting-control"},blockLimit:0,blockTypeLimits:{},required:[],uploadUrl:"/attachments",baseImageUrl:"/sir-trevor-uploads/"},r.Blocks={},r.Formatters={},r.instances=[];var i=!1,s={bound:[],_bindFunctions:function(){var e=[];e.push(this),e.join(this.bound),t.bindAll.apply(this,e)}};(function(e){function t(e){u(e)}function n(e){e.originalEvent.dataTransfer.dropEffect="copy",u(e)}function r(e){u(e)}e.fn.dropArea=function(){return this.bind("dragenter",t).bind("dragover",n).bind("dragleave",r),this},e.fn.noDropArea=function(){return this.unbind("dragenter").unbind("dragover").unbind("dragleave"),this}})(jQuery);var l=function(e,t){return h(this,e,t)},c=function(){},h=function(e,n,r){var i;return n&&n.hasOwnProperty("constructor")?i=n.constructor:i=function(){e.apply(this,arguments)},t.extend(i,e),c.prototype=e.prototype,i.prototype=new c,n&&t.extend(i.prototype,n),r&&t.extend(i,r),i.prototype.constructor=i,i.__super__=e.prototype,i};r.log=function(e){!t.isUndefined(console)&&r.DEBUG&&console.log(e)};var d=e(r);r.subscribe=r.on=function(){d.on.apply(d,arguments)},r.unsubscribe=r.off=function(){d.off.apply(d,arguments)},r.publish=r.trigger=function(){d.trigger.apply(d,arguments)},r.subscribeAll=function(e){t.each(e,function(e){d.on.apply(d,arguments)})},function(e,t,n){function r(e,n){var r=t.createElement(e||"div"),i;for(i in n)r[i]=n[i];return r}function i(e){for(var t=1,n=arguments.length;t<n;t++)e.appendChild(arguments[t]);return e}function s(e,t,n,r){var i=["opacity",t,~~(e*100),n,r].join("-"),s=.01+n/r*100,o=Math.max(1-(1-e)/t*(100-s),e),u=h.substring(0,h.indexOf("Animation")).toLowerCase(),a=u&&"-"+u+"-"||"";return c[i]||(p.insertRule("@"+a+"keyframes "+i+"{"+"0%{opacity:"+o+"}"+s+"%{opacity:"+e+"}"+(s+.01)+"%{opacity:1}"+(s+t)%100+"%{opacity:"+e+"}"+"100%{opacity:"+o+"}"+"}",0),c[i]=1),i}function o(e,t){var r=e.style,i,s;if(r[t]!==n)return t;t=t.charAt(0).toUpperCase()+t.slice(1);for(s=0;s<l.length;s++){i=l[s]+t;if(r[i]!==n)return i}}function u(e,t){for(var n in t)e.style[o(e,n)||n]=t[n];return e}function a(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var i in r)e[i]===n&&(e[i]=r[i])}return e}function f(e){var t={x:e.offsetLeft,y:e.offsetTop};while(e=e.offsetParent)t.x+=e.offsetLeft,t.y+=e.offsetTop;return t}var l=["webkit","Moz","ms","O"],c={},h,p=function(){var e=r("style");return i(t.getElementsByTagName("head")[0],e),e.sheet||e.styleSheet}(),d={lines:12,length:7,width:5,radius:10,rotate:0,color:"#000",speed:1,trail:100,opacity:.25,fps:20,zIndex:2e9,className:"spinner",top:"auto",left:"auto"},v=function m(e){if(!this.spin)return new m(e);this.opts=a(e||{},m.defaults,d)};v.defaults={},a(v.prototype,{spin:function(e){this.stop();var t=this,n=t.opts,i=t.el=u(r(0,{className:n.className}),{position:"relative",zIndex:n.zIndex}),s=n.radius+n.length+n.width,o,a;e&&(e.insertBefore(i,e.firstChild||null),a=f(e),o=f(i),u(i,{left:(n.left=="auto"?a.x-o.x+(e.offsetWidth>>1):n.left+s)+"px",top:(n.top=="auto"?a.y-o.y+(e.offsetHeight>>1):n.top+s)+"px"})),i.setAttribute("aria-role","progressbar"),t.lines(i,t.opts);if(!h){var l=0,c=n.fps,p=c/n.speed,d=(1-n.opacity)/(p*n.trail/100),v=p/n.lines;!function m(){l++;for(var e=n.lines;e;e--){var r=Math.max(1-(l+e*v)%p*d,n.opacity);t.opacity(i,n.lines-e,r,n)}t.timeout=t.el&&setTimeout(m,~~(1e3/c))}()}return t},stop:function(){var e=this.el;return e&&(clearTimeout(this.timeout),e.parentNode&&e.parentNode.removeChild(e),this.el=n),this},lines:function(e,t){function n(e,n){return u(r(),{position:"absolute",width:t.length+t.width+"px",height:t.width+"px",background:e,boxShadow:n,transformOrigin:"left",transform:"rotate("+~~(360/t.lines*o+t.rotate)+"deg) translate("+t.radius+"px"+",0)",borderRadius:(t.width>>1)+"px"})}var o=0,a;for(;o<t.lines;o++)a=u(r(),{position:"absolute",top:1+~(t.width/2)+"px",transform:t.hwaccel?"translate3d(0,0,0)":"",opacity:t.opacity,animation:h&&s(t.opacity,t.trail,o,t.lines)+" "+1/t.speed+"s linear infinite"}),t.shadow&&i(a,u(n("#000","0 0 4px #000"),{top:"2px"})),i(e,i(a,n(t.color,"0 0 1px rgba(0,0,0,.1)")));return e},opacity:function(e,t,n){t<e.childNodes.length&&(e.childNodes[t].style.opacity=n)}}),!function(){function e(e,t){return r("<"+e+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',t)}var t=u(r("group"),{behavior:"url(#default#VML)"});!o(t,"transform")&&t.adj?(p.addRule(".spin-vml","behavior:url(#default#VML)"),v.prototype.lines=function(t,n){function r(){return u(e("group",{coordsize:a+" "+a,coordorigin:-o+" "+ -o}),{width:a,height:a})}function s(t,s,a){i(l,i(u(r(),{rotation:360/n.lines*t+"deg",left:~~s}),i(u(e("roundrect",{arcsize:1}),{width:o,height:n.width,left:n.radius,top:-n.width>>1,filter:a}),e("fill",{color:n.color,opacity:n.opacity}),e("stroke",{opacity:0}))))}var o=n.length+n.width,a=2*o,f=-(n.width+n.length)*2+"px",l=u(r(),{position:"absolute",top:f,left:f}),c;if(n.shadow)for(c=1;c<=n.lines;c++)s(c,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(c=1;c<=n.lines;c++)s(c);return i(t,l)},v.prototype.opacity=function(e,t,n,r){var i=e.firstChild;r=r.shadow&&r.lines||0,i&&t+r<i.childNodes.length&&(i=i.childNodes[t+r],i=i&&i.firstChild,i=i&&i.firstChild,i&&(i.opacity=n))}):h=o(t,"animation")}(),e.Spinner=v}(window,document),function(e){e.fn.limit_chars=function(){if(this.length===0)return;this.attr("maxlength")&&(this.attr("data-maxlength",this.attr("maxlength")),this.removeAttr("maxlength")),this.parents(".extended_input").length===0&&(count=this.chars()<this.attr("data-maxlength")?this.chars():"<em>"+this.chars()+"</em>",this.wrap(e("<div>",{"class":"extended_input"})).after(e("<span>",{"class":"count",html:count+" of "+this.attr("data-maxlength")})),this.bind("keydown keyup paste",function(t){count=e(this).chars()<e(this).attr("data-maxlength")?e(this).chars():"<em>"+e(this).chars()+"</em>",e(this).parent().find(".count").html(count+" of "+e(this).attr("data-maxlength"))}))},e.fn.chars=function(){return count=this.attr("contenteditable")!==undefined?this.text().length:this.val().length,count},e.fn.too_long=function(){return this.chars()>this.attr("data-maxlength")}}(jQuery),r.blockStore=function(e,t,n){var r;n=n||{};switch(e){case"create":var i=n.data||{};t.dataStore={type:t.type.toLowerCase(),data:i};break;case"save":n.data&&(t.dataStore.data=n.data,r=t.dataStore);break;case"read":r=t.dataStore}if(r)return r},r.editorStore=function(e,n,r){var i;r=r||{};switch(e){case"create":var s=t.trim(n.$el.val());n.dataStore={data:[]};if(s.length>0)try{var o=JSON.parse(s);t.isUndefined(o.data)||(n.dataStore=o)}catch(u){console.log("Sorry there has been a problem with parsing the JSON"),console.log(u)}break;case"reset":n.dataStore={data:[]};break;case"add":r.data&&(n.dataStore.data.push(r.data),i=n.dataStore);break;case"save":n.$el.val(n.dataStore.data.length>0?JSON.stringify(n.dataStore):"");break;case"read":i=n.dataStore}if(i)return i};var v=function(){this.intialize()};t.extend(v.prototype,{intialize:function(){this.submitBtn=e("input[type='submit']");var n=[];t.each(this.submitBtn,function(t){n.push(e(t).attr("value"))}),this.submitBtnTitles=n,this.canSubmit=!0,this.globalUploadCount=0,this._bindEvents()},setSubmitButton:function(e,t){this.submitBtn.attr("value",t)},resetSubmitButton:function(){t.each(this.submitBtn,t.bind(function(t,n){e(t).attr("value",this.submitBtnTitles[n])},this))},onUploadStart:function(e){this.globalUploadCount++,r.log("onUploadStart called "+this.globalUploadCount),this.globalUploadCount===1&&this._disableSubmitButton()},onUploadStop:function(e){this.globalUploadCount=this.globalUploadCount<=0?0:this.globalUploadCount-1,r.log("onUploadStop called "+this.globalUploadCount),this.globalUploadCount===0&&this._enableSubmitButton()},onError:function(e){r.log("onError called"),this.canSubmit=!1},_disableSubmitButton:function(e){this.setSubmitButton(null,e||"Please wait..."),this.submitBtn.attr("disabled","disabled").addClass("disabled")},_enableSubmitButton:function(){this.resetSubmitButton(),this.submitBtn.removeAttr("disabled").removeClass("disabled")},_bindEvents:function(){r.subscribe("disableSubmitButton",t.bind(this._disableSubmitButton,this)),r.subscribe("enableSubmitButton",t.bind(this._enableSubmitButton,this)),r.subscribe("setSubmitButton",t.bind(this.setSubmitButton,this)),r.subscribe("resetSubmitButton",t.bind(this.resetSubmitButton,this)),r.subscribe("onError",t.bind(this.onError,this)),r.subscribe("onUploadStart",t.bind(this.onUploadStart,this)),r.subscribe("onUploadStop",t.bind(this.onUploadStop,this))}}),r.submittable=function(){new v},r.fileUploader=function(n,i,s,o){r.publish("onUploadStart");var u=[n.instance.ID,(new Date).getTime(),"raw"].join("-"),a=new FormData;a.append("attachment[name]",i.name),a.append("attachment[file]",i),a.append("attachment[uid]",u);var f=function(e){!t.isUndefined(s)&&t.isFunction(s)&&(r.log("Upload callback called"),r.publish("onUploadStop"),t.bind(s,n)(e))},l=function(e,i,s){!t.isUndefined(o)&&t.isFunction(o)&&(r.log("Upload callback error called"),r.publish("onUploadError"),t.bind(o,n)(i))};e.ajax({url:n.instance.options.uploadUrl,data:a,cache:!1,contentType:!1,processData:!1,type:"POST",success:f,error:l})};var m=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/;t.mixin({isURI:function(e){return m.test(e)},capitalize:function(e){return e.charAt(0).toUpperCase()+e.substring(1).toLowerCase()},trim:function(e){return e.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}});var g=r.Block=function(e,n){this.instance=e,this.type=this._getBlockType(),this.store("create",this,{data:n}),this.uploadsCount=0,this.blockID=t.uniqueId(this.className+"-"),this._setBaseElements(),this._bindFunctions(),this.render(),this.initialize.apply(this,arguments)},y=["className","toolbarEnabled","formattingEnabled","dropEnabled","title","limit","editorHTML","dropzoneHTML","validate","loadData","toData","onDrop","onContentPasted","onBlockRender","beforeBlockRender","setTextLimit","toMarkdown","toHTML"];t.extend(g.prototype,s,{bound:["_handleDrop","_handleContentPaste","onBlockFocus","onBlockBlur","onDrop","onDragStart","onDragEnd"],$:function(e){return this.$el.find(e)},$$:function(e){return this.$editor.find(e)},className:"",title:"",limit:0,editorHTML:"<div></div>",dropzoneHTML:'<div class="dropzone"><p>Drop content here</p></div>',toolbarEnabled:!0,dropEnabled:!1,formattingEnabled:!0,initialize:function(){},loadData:function(e){},onBlockRender:function(){},beforeBlockRender:function(){},setTextLimit:function(){},toMarkdown:function(e){return e},toHTML:function(e){return e},store:function(){return r.blockStore.apply(this,arguments)},render:function(){this.beforeBlockRender(),this.instance.marker.hide(),this.instance.marker.$el.before(this.$el),this.dropEnabled&&this._initDragDrop();var n=this.getData();!t.isUndefined(n)&&!t.isEmpty(n)&&this._loadData(),this.save(),this.$el.append(e("<span>",{"class":this.instance.baseCSS("drag-handle"),draggable:!0})),this.$el.append(e("<span>",{"class":this.instance.baseCSS("remove-block")})),this.$el.bind("drop",u).bind("mouseover",u).bind("mouseout",u).bind("dragleave",u).bind("mouseover",function(t){e(this).siblings().removeClass("active"),e(this).addClass("active")}).bind("mouseout",function(t){e(this).removeClass("active")}).bind("dragover",function(e){e.preventDefault()}),this._initPaste(),this.$("."+this.instance.baseCSS("remove-block")).bind("click",this.onDeleteClick),this.$$(".text-block").length>0&&(document.execCommand("styleWithCSS",!1,!1),document.execCommand("insertBrOnReturn",!1,!0),this.$$(".text-block").bind("paste",this._handleContentPaste).bind("focus",this.onBlockFocus).bind("blur",this.onBlockBlur),this._initFormatting());if(t.isEmpty(n.data)&&this.instance.blocks.length>0){var r=this.$$('[contenteditable="true"], input');r.length>0&&!this.dropEnabled&&r[0].focus()}this._initReordering(),this.$el.addClass(this.instance.baseCSS("item-ready")),this.setTextLimit(),this.onBlockRender()},remove:function(){this.$el.remove()},save:function(){return this.toData(),this.store("read",this)},getData:function(){return this.store("read",this).data},setData:function(e){r.log("Setting data for block "+this.blockID),this.store("save",this,{data:e})},loading:function(){t.isUndefined(this.spinner)||this.ready(),this.spinner=new Spinner(this.instance.options.spinner),this.spinner.spin(this.$el[0]),this.$el.addClass("loading")},ready:function(){this.$el.removeClass("loading"),t.isUndefined(this.spinner)||(this.spinner.stop(),delete this.spinner)},validate:function(){this._beforeValidate();var n=this.$$(".required, [data-maxlength]"),r=0;return t.each(n,t.bind(function(t){t=e(t);var n=t.attr("contenteditable")?t.text():t.val(),i=t.attr("data-maxlength")&&t.too_long(),s=t.hasClass("required");if(s&&n.length===0||i)t.addClass(this.instance.baseCSS(this.instance.options.errorClass)),r++},this)),r>0&&this.$el.addClass(this.instance.baseCSS("block-with-errors")),r===0},toData:function(){r.log("toData for "+this.blockID);var n=this.$el,i={};if(this.$$(".text-block").length>0){var s=this.$$(".text-block").html();s.length>0&&(i.text=this.instance._toMarkdown(s,this.type))}var o=!t.isUndefined(i.text)||this.$$(".text-block").length===0;this.$$('input[type="text"]').not(".paste-block").length>0&&this.$$('input[type="text"]').each(function(t,n){n=e(n),n.val().length>0&&o&&(i[n.attr("name")]=n.val())}),this.$$("select").each(function(t,n){n=e(n),n.val().length>0&&o&&(i[n.attr("name")]=n.val())}),this.$$('input[type="file"]').each(function(t,n){n=e(n),i.file=n.data("json")}),t.isEmpty(i)||this.setData(i)},onDrop:function(e){},onDragStart:function(t){var n=e(t.target);t.originalEvent.dataTransfer.setDragImage(n.parent()[0],13,25),t.originalEvent.dataTransfer.setData("Text",n.parent().attr("id")),n.parent().addClass("dragging"),this.instance.formatBar.hide()},onDragEnd:function(t){var n=e(t.target);n.parent().removeClass("dragging"),this.instance.marker.hide(),this.instance.formatBar.show()},onDeleteClick:function(e){confirm("Are you sure you wish to delete this content?")&&(this.instance.removeBlock(this),u(e))},onContentPasted:function(e){var t=this.$$(".text-block");t.length>0&&t.html(this.instance._toHTML(this.instance._toMarkdown(t.html(),this.type),this.type))},onBlockFocus:function(e){this.$el.addClass("focussed")},onBlockBlur:function(e){this.$el.removeClass("focussed")},uploader:function(e,t){r.fileUploader(this,e,t)},_loadData:function(){r.log("loadData for "+this.blockID),this.loading(),this.dropEnabled&&(this.$dropzone.hide(),this.$editor.show()),r.publish("editor/block/loadData"),this.loadData(this.getData()),this.ready()},_beforeValidate:function(){this.errors=[];var e=this.instance.baseCSS("error");this.$el.removeClass(this.instance.baseCSS("block-with-errors")),this.$("."+e).removeClass(e),this.$(".error-marker").remove()},_handleContentPaste:function(e){var n=function(e){this.onContentPasted(e)};t.delay(t.bind(n,this,e),100)},_handleDrop:function(n){n.preventDefault(),n=n.originalEvent,r.publish("editor/block/handleDrop");var i=e(n.target),s=n.dataTransfer.types,o,u=[];this.instance.marker.hide(),this.$dropzone.removeClass("drag-enter"),t.isUndefined(s)||(t.include(s,"Files")||t.include(s,"text/plain")||t.include(s,"text/uri-list"))&&this.onDrop(n.dataTransfer)},_setBaseElements:function(){var n=t.isFunction(this.editorHTML)?this.editorHTML():this.editorHTML,r=e("<div>",{"class":this.instance.baseCSS("editor-block")+" "+this._getBlockClass(),html:n});this.$el=e("<div>",{"class":this.instance.baseCSS("block"),id:this.blockID,"data-type":this.type,"data-instance":this.instance.ID,html:r}),this.el=this.$el[0],this.$editor=r},_getBlockType:function(){var e="";for(var t in r.Blocks)r.Blocks[t].prototype==Object.getPrototypeOf(this)&&(e=t);return e},_getBlockClass:function(){return this.className+"-block"},_initDragDrop:function(){r.log("Adding drag and drop capabilities for block "+this.blockID),this.$dropzone=e("<div>",{html:this.dropzoneHTML,"class":"dropzone "+this._getBlockClass()}),this.$el.append(this.$dropzone),this.$editor.hide(),this.$dropzone.bind("drop",this._handleDrop).bind("dragenter",function(t){u(t),e(this).addClass("drag-enter")}).bind("dragover",function(t){t.originalEvent.dataTransfer.dropEffect="copy",u(t),e(this).addClass("drag-enter")}).bind("dragleave",function(t){u(t),e(this).removeClass("drag-enter")})},_initReordering:function(){this.$("."+this.instance.baseCSS("drag-handle")).bind("dragstart",this.onDragStart).bind("dragend",this.onDragEnd).bind("drag",this.instance.marker.show)},_initFormatting:function(){var e;for(var n in this.instance.formatters)this.instance.formatters.hasOwnProperty(n)&&(e=r.Formatters[n],t.isUndefined(e.keyCode)||e._bindToBlock(this.$editor))},_initPaste:function(){this.$(".paste-block").bind("click",function(){e(this).select()}).bind("paste",this._handleContentPaste).bind("submit",this._handleContentPaste)},_initTextLimits:function(){this.$$("input[maxlength!=-1][maxlength!=524288][maxlength!=2147483647]").limit_chars()}}),g.extend=l;var b=r.Formatter=function(e){this.formatId=t.uniqueId("format-"),this._configure(e||{}),this.initialize.apply(this,arguments)},w=["title","className","cmd","keyCode","param","onClick","toMarkdown","toHTML"];t.extend(b.prototype,{title:"",className:"",cmd:null,keyCode:null,param:null,toMarkdown:function(e){return e},toHTML:function(e){return e},initialize:function(){},_configure:function(e){this.options&&(e=t.extend({},this.options,e));for(var n=0,r=w.length;n<r;n++){var i=w[n];e[i]&&(this[i]=e[i])}this.options=e},_bindToBlock:function(e){var t=this,n=!1;e.on("keyup",".text-block",function(e){if(e.which==17||e.which==224)n=!1}).on("keydown",".text-block",{formatter:t},function(e){if(e.which==17||e.which==224)n=!0;e.which==e.data.formatter.keyCode&&n===!0&&(document.execCommand(e.data.formatter.cmd,!1,!0),e.preventDefault())})}}),b.extend=l,r.Blocks.Quote=r.Block.extend({title:"Quote",className:"quote",limit:0,editorHTML:function(){return t.template('<blockquote class="required text-block <%= className %>" contenteditable="true"></blockquote><div class="input text"><label>Credit</label><input maxlength="140" name="cite" class="input-string required" type="text" /></div>',this)},loadData:function(e){this.$$(".text-block").html(this.instance._toHTML(e.text,this.type)),this.$$("input").val(e.cite)},toMarkdown:function(e){return e.replace(/^(.+)$/mg,"> $1")}});var E='<p>Drop images here</p><div class="input submit"><input type="file" multiple="multiple" /></div><button>...or choose file(s)</button>';r.Blocks.Gallery=r.Block.extend({title:"Gallery",className:"gallery",dropEnabled:!0,editorHTML:'<div class="gallery-items"><p>Gallery Contents:</p><ul></ul></div>',dropzoneHTML:E,loadData:function(e){t.isArray(e)&&(t.each(e,t.bind(function(e){this.renderGalleryThumb(e)},this)),this.$dropzone.show())},renderGalleryThumb:function(n){if(t.isUndefined(n.data.file))return!1;var r=e("<img>",{src:n.data.file.thumb.url}),i=e("<li>",{id:t.uniqueId("gallery-item"),"class":"gallery-item",html:r});i.append(e("<span>",{"class":"delete",click:t.bind(function(t){u(t),confirm("Are you sure you wish to delete this image?")&&(e(t.target).parent().remove(),this.reindexData())},this)})),i.data("block",n),this.$$("ul").append(i),i.dropArea().bind("dragstart",t.bind(function(t){var n=e(t.target);t.originalEvent.dataTransfer.setData("Text",n.parent().attr("id")),n.parent().addClass("dragging")},this)).bind("drag",t.bind(function(e){},this)).bind("dragend",t.bind(function(t){var n=e(t.target);n.parent().removeClass("dragging")},this)).bind("dragover",t.bind(function(t){var n=e(t.target);n.parents("li").addClass("dragover")},this)).bind("dragleave",t.bind(function(t){var n=e(t.target);n.parents("li").removeClass("dragover")},this)).bind("drop",t.bind(function(t){var n=e(t.target),r=n.parent();n=n.hasClass("gallery-item")?n:r,this.$$("ul li.dragover").removeClass("dragover");var i=e("#"+t.originalEvent.dataTransfer.getData("text/plain"));if(i.attr("id")===n.attr("id"))return!1;i.length>0&&i.hasClass("gallery-item")&&n.before(i),this.reindexData()},this))},onBlockRender:function(){this.$dropzone.find("button").bind("click",u),this.$dropzone.find("input").on("change",t.bind(function(e){this.onDrop(e.currentTarget)},this))},reindexData:function(){var n=this.getData();n=[],t.each(this.$$("li.gallery-item"),function(t){t=e(t),n.push(t.data("block"))}),this.setData(n)},onDrop:function(e){if(e.files.length>0){var n=e.files.length,r,i=typeof URL!="undefined"?URL:typeof webkitURL!="undefined"?webkitURL:null;this.loading();while(n--)r=e.files[n],/image/.test(r.type)&&(this.uploadsCount+=1,this.$editor.show(),this.uploader(r,function(e){this.uploadsCount-=1;var n=this.getData();e={type:"image",data:e},t.isArray(n)||(n=[]),n.push(e),this.setData(n),this.renderGalleryThumb(e),this.uploadsCount===0&&this.ready()}))}}});var E='<p>Drop image here</p><div class="input submit"><input type="file" /></div><button>...or choose a file</button>';r.Blocks.Image=r.Block.extend({title:"Image",className:"image",dropEnabled:!0,dropzoneHTML:E,loadData:function(t){this.$editor.html(e("<img>",{src:t.file.url}))},onBlockRender:function(){this.$dropzone.find("button").bind("click",u),this.$dropzone.find("input").on("change",t.bind(function(e){this.onDrop(e.currentTarget)},this))},onDrop:function(t){var n=t.files[0],i=typeof URL!="undefined"?URL:typeof webkitURL!="undefined"?webkitURL:null;/image/.test(n.type)&&(this.loading(),this.$dropzone.hide(),this.$editor.html(e("<img>",{src:i.createObjectURL(n)})),this.$editor.show(),r.publish("setSubmitButton",["Please wait..."]),this.uploader(n,function(e){this.setData(e),this.ready()},function(e){alert("Error!")}))}}),r.Blocks.Text=r.Block.extend({title:"Text",className:"text",limit:0,editorHTML:'<div class="required text-block" contenteditable="true"></div>',loadData:function(e){this.$$(".text-block").html(this.instance._toHTML(e.text,this.type))}});var S='<p>Drop tweet link here</p><div class="input text"><label>or paste URL:</label><input type="text" class="paste-block"></div>',x='<div class="tweet media"><div class="img"><img src="<%= user.profile_image_url %>" class="tweet-avatar"></div><div class="bd tweet-body"><p><a href="http://twitter.com/#!/<%= user.screen_name %>">@<%= user.screen_name %></a>: <%= text %></p><time><%= created_at %></time></div></div>';r.Blocks.Tweet=r.Block.extend({title:"Tweet",className:"tweet",dropEnabled:!0,dropzoneHTML:S,loadData:function(e){this.$editor.html(t.template(x,e))},onContentPasted:function(t){var n=e(t.target),r=n.val();this.handleTwitterDropPaste(r)},handleTwitterDropPaste:function(n){if(t.isURI(n)&&n.indexOf("twitter")!=-1&&n.indexOf("status")!=-1){var r=n.match(/[^\/]+$/);if(!t.isEmpty(r)){this.loading(),r=r[0];var i=function(e){var t={user:{profile_image_url:e.user.profile_image_url,profile_image_url_https:e.user.profile_image_url_https,screen_name:e.user.screen_name,name:e.user.name},text:e.text,created_at:e.created_at,status_url:n};this.setData(t),this._loadData(),this.ready()},s=function(){this.ready()};e.ajax({url:"//api.twitter.com/1/statuses/show/"+r+".json",dataType:"JSONP",success:t.bind(i,this),error:t.bind(s,this)})}}},onDrop:function(e){var t=e.getData("text/plain");this.handleTwitterDropPaste(t)}});var T='<div class="text-block <%= className %>" contenteditable="true"></div>';r.Blocks.Ul=r.Block.extend({title:"List",className:"list",editorHTML:function(){return t.template(T,this)},onBlockRender:function(){this.$$(".text-block").bind("click",function(){e(this).html().length===0&&document.execCommand("insertUnorderedList",!1,!1)}),t.isEmpty(this.data)&&this.$$(".text-block").focus().click()},loadData:function(e){this.$$(".text-block").html("<ul>"+this.instance._toHTML(e.text,this.type)+"</ul>")},toMarkdown:function(e){return e.replace(/<\/li>/mg,"\n").replace(/<\/?[^>]+(>|$)/g,"").replace(/^(.+)$/mg," - $1")},toHTML:function(e){return e=e.replace(/^ - (.+)$/mg,"<li>$1</li>").replace(/\n/mg,""),e="<ul>"+e+"</ul>",e}});var N='<p>Drop video link here</p><div class="input text"><label>or paste URL:</label><input type="text" class="paste-block"></div>',C=/http[s]?:\/\/(?:www.)?(?:(vimeo).com\/(.*))|(?:(youtu(?:be)?).(?:be|com)\/(?:watch\?v=)?([^&]*)(?:&(?:.))?)/;r.Blocks.Video=r.Block.extend({title:"Video",className:"video",dropEnabled:!0,dropzoneHTML:N,loadData:function(e){e.source=="youtube"||e.source=="youtu"?this.$editor.html('<iframe src="'+window.location.protocol+"//www.youtube.com/embed/"+e.remote_id+'" width="580" height="320" frameborder="0" allowfullscreen></iframe>'):e.source=="vimeo"&&this.$editor.html('<iframe src="'+window.location.protocol+"//player.vimeo.com/video/"+e.remote_id+'?title=0&byline=0" width="580" height="320" frameborder="0"></iframe>')},onContentPasted:function(t){var n=e(t.target),r=n.val();this.handleDropPaste(r)},handleDropPaste:function(e){if(t.isURI(e))if(e.indexOf("youtu")!=-1||e.indexOf("vimeo")!=-1){var n={},r=e.match(C);r[3]!==undefined?(n.source=r[3],n.remote_id=r[4]):r[1]!==undefined&&(n.source=r[1],n.remote_id=r[2]),n.source=="youtu"&&(n.source="youtube"),this.setData(n),this._loadData()}},onDrop:function(e){var t=e.getData("text/plain");this.handleDropPaste(t)}});var k=r.Formatter.extend({title:"B",className:"bold",cmd:"bold",keyCode:66}),L=r.Formatter.extend({title:"I",className:"italic",cmd:"italic",keyCode:73}),A=r.Formatter.extend({title:"U",className:"underline",cmd:"underline"}),O=r.Formatter.extend({title:"Link",className:"link",cmd:"CreateLink",onClick:function(){var e=prompt("Enter a link"),t=/(ftp|http|https):\/\/./;e&&e.length>0&&(t.test(e)||(e="http://"+e),document.execCommand(this.cmd,!1,e))}}),M=r.Formatter.extend({title:"Unlink",className:"link",cmd:"unlink"});r.Formatters.Bold=new k,r.Formatters.Italic=new L,r.Formatters.Link=new O,r.Formatters.Unlink=new M;var _=r.Marker=function(e,n){this.instance=n,this.options=t.extend({},r.DEFAULTS.marker,e||{}),this._bindFunctions()};t.extend(_.prototype,s,{bound:["onButtonClick","show","hide","onDrop"],render:function(){var n=e("<div>",{"class":this.instance.baseCSS(this.options.baseCSSClass),html:"<p>"+this.options.addText+"</p>"}),i=e("<div>",{"class":this.instance.baseCSS("buttons")});n.append(i),this.instance.$wrapper.append(n),this.$el=n,this.$btns=i,this.$p=this.$el.find("p");var s,o;for(s in this.instance.blockTypes)r.Blocks.hasOwnProperty(s)&&(o=r.Blocks[s],o.prototype.toolbarEnabled&&this.$btns.append(e("<a>",{href:"#","class":this.instance.baseCSS(this.options.buttonClass)+" new-"+o.prototype.className,"data-type":s,text:o.prototype.title,click:this.onButtonClick})));this.$btns.children().length===0&&this.$el.addClass("hidden");var a=t.throttle(this.show,0),f=t.throttle(this.hide,0);this.instance.$outer.bind("mouseover",a).bind("mouseout",f).bind("dragover",a),this.$el.bind("dragover",u),this.instance.$outer.dropArea().bind("dragleave",f).bind("drop",this.onDrop),this.$el.addClass(this.instance.baseCSS("item-ready"))},show:function(n){var r=e(n.target),i=r.parent();if(r.is(this.$el)||r.is(this.$btns)||i.is(this.$el)||i.is(this.$btns)){this.$el.addClass(this.instance.baseCSS("item-ready"));return}n.type=="drag"||n.type=="dragover"?(this.$el.addClass("drop-zone"),this.$p.text(this.options.dropText),this.$btns.hide()):(this.$el.removeClass("drop-zone"),this.$p.text(this.options.addText),this.$btns.show());if(r.is(this.instance.formatBar.$el)||i.is(this.instance.formatBar.$el))return this.hide();var s=n?n.originalEvent.pageY-this.instance.$wrapper.offset().top:0;if(this.instance.blocks.length>0){var o=!1,u=this.instance.$wrapper,a="."+this.instance.baseCSS("block"),f=function(t,n){t=e(t);var r=t.offset().top-40,i=t.offset().top+t.outerHeight(!0)-40;r<=s&&s<i&&(o=t)};t.each(u.find(a),t.bind(f,this)),o?this.$el.insertBefore(o):s>0?this.$el.insertAfter(u.find(a).last()):this.$el.insertBefore(u.find(a).first())}this.$el.addClass(this.instance.baseCSS("item-ready"))},hide:function(e){this.$el.removeClass(this.instance.baseCSS("item-ready"))},onDrop:function(n){n.preventDefault();var r=this.$el,i=n.originalEvent.dataTransfer.getData("text/plain"),s=e("#"+i);!t.isUndefined(i)&&!t.isEmpty(s)&&s.attr("data-instance")==this.instance.ID&&r.after(s)},remove:function(){this.$el.remove()},onButtonClick:function(t){u(t);var n=e(t.target);if(n.hasClass("inactive"))return alert("You cannot create any more blocks of this type"),!1;this.instance.createBlock(n.attr("data-type"),{})},move:function(e){this.$el.css({top:e}).show().addClass(this.instance.baseCSS("item-ready"))}});var D=r.FormatBar=function(e,n){this.instance=n,this.options=t.extend({},r.DEFAULTS.formatBar,e||{}),this.className=this.instance.baseCSS(this.options.baseCSSClass),this.clicked=!1,this._bindFunctions()};t.extend(D.prototype,s,{bound:["onFormatButtonClick"],render:function(){var n=e("<div>",{"class":this.className});this.instance.$wrapper.prepend(n),this.$el=n;var i=this.instance.formatters,s,o;for(s in i)r.Formatters.hasOwnProperty(s)&&(o=r.Formatters[s],e("<button>",{"class":this.instance.baseCSS("format-button"),text:o.title,"data-type":s,"data-cmd":o.cmd,click:this.onFormatButtonClick}).appendTo(this.$el));var u=t.throttle(t.bind(this.handleDocumentScroll,this),150);e(document).bind("scroll",u),this.$el.find("button").length===0&&this.$el.addClass("hidden"),this.show()},handleDocumentScroll:function(){var t=this.instance.$outer.height(),n=this.instance.$outer.offset().top,r=e(document).scrollTop();this.$el.hasClass("fixed")&&(n=this.$el.offset().top),r>5&&r>=n?(this.$el.addClass("fixed"),this.instance.$wrapper.css({"padding-top":"104px"})):(this.$el.removeClass("fixed"),this.instance.$wrapper.css({"padding-top":"16px"}))},hide:function(){this.$el.removeClass(this.instance.baseCSS("item-ready"))},show:function(){this.$el.addClass(this.instance.baseCSS("item-ready"))},remove:function(){this.$el.remove()},onFormatButtonClick:function(n){u(n);var i=e(n.target),s=r.Formatters[i.attr("data-type")];!t.isUndefined(s.onClick)&&t.isFunction(s.onClick)?s.onClick():document.execCommand(i.attr("data-cmd"),!1,s.param),this.show()}});var P=r.Editor=function(e){r.log("Init SirTrevor.Editor"),this.blockTypes={},this.formatters={},this.blockCounts={},this.blocks=[],this.errors=[],this.options=t.extend({},r.DEFAULTS,e||{}),this.ID=t.uniqueId(this.options.baseCSSClass+"-"),this._ensureAndSetElements()&&(this.marker=new r.Marker(this.options.marker,this),this.formatBar=new r.FormatBar(this.options.formatBar,this),!t.isUndefined(this.options.onEditorRender)&&t.isFunction(this.options.onEditorRender)&&(this.onEditorRender=this.options.onEditorRender),this._setRequired(),this._setBlocksAndFormatters(),this._bindFunctions(),this.store("create",this),this.build(),r.instances.push(this),r.bindFormSubmit(this.$form))};t.extend(P.prototype,s,{bound:["onFormSubmit"],initialize:function(){},build:function(){this.$el.hide(),this.marker.render(),this.formatBar.render();var e=this.store("read",this);e.data.length===0?this.createBlock(this.options.defaultType):t.each(e.data,t.bind(function(e){r.log("Creating: ",e),this.createBlock(e.type,e.data)},this)),this.$wrapper.addClass("sir-trevor-ready"),t.isUndefined(this.onEditorRender)||this.onEditorRender()},store:function(){return r.editorStore.apply(this,arguments)},createBlock:function(e,n){e=t.capitalize(e);if(this._blockTypeAvailable(e)){var i=r.Blocks[e],s=t.isUndefined(this.blockCounts[e])?0:this.blockCounts[e],o=this.blocks.length,u=this._getBlockTypeLimit(e);if(u!==0&&s>u||this.options.blockLimit!==0&&o>=this.options.blockLimit)return r.log("Block Limit reached for type "+e),!1;var a=new i(this,n||{});t.isUndefined(this.blockCounts[e])&&(this.blockCounts[e]=0),this.blocks.push(a),s++,this.blockCounts[e]=s,this.options.blockLimit!==0&&this.blocks.length>=this.options.blockLimit&&this.marker.$el.addClass("hidden"),u!==0&&s>=u&&(r.log("Block Limit reached for type "+e+" setting state as inactive"),this.marker.$el.find('[data-type="'+e+'"]').addClass("inactive").attr("title","You have reached the limit for this type of block")),r.publish("editor/block/createBlock"),r.log("Block created of type "+e)}else r.log("Block type not available "+e)},removeBlock:function(e){e.remove(),this.blockCounts[e.type]=this.blockCounts[e.type]-1,this.blocks=t.reject(this.blocks,function(t){return t.blockID==e.blockID}),t.isUndefined(this.blocks)&&(this.blocks=[]),r.publish("editor/block/removeBlock"),this._getBlockTypeLimit(e.type)>this.blockCounts[e.type]&&(r.log("Removing block limit for "+e.type),this.marker.$el.find('[data-type="'+e.type+'"]').removeClass("inactive").attr("title","Add a "+e.type+" block"))},performValidations:function(e,n){var i=0;!r.SKIP_VALIDATION&&n?e.validate()||(r.log("Block "+e.blockID+" failed validation"),++i):e._beforeValidate();var s=e.save();return t.isEmpty(s.data)||(r.log("Adding data for block "+e.blockID+" to block store"),this.store("add",this,{data:s})),i},onFormSubmit:function(n){n=n===!1?!1:!0,r.log("Handling form submission for Editor "+this.ID);var i,s,o,u=0;this.removeErrors(),this.store("reset",this);var a=function(i,s){i=e(i);var o=t.find(this.blocks,function(e){return e.blockID==i.attr("id")});if(!t.isUndefined(o)||!t.isEmpty(o)||typeof o==r.Block)u+=this.performValidations(o,n)};return t.each(this.$wrapper.find("."+this.options.baseCSSClass+"-block"),t.bind(a,this)),this.required&&!r.SKIP_VALIDATION&&n&&t.each(this.required,t.bind(function(e){if(this._blockTypeAvailable(e))if(t.isUndefined(this.blockCounts[e])||this.blockCounts[e]===0)this.errors.push({text:"You must have a block of type "+e}),r.log("Failed validation on required block type "+e),u++;else{var n=t.filter(this.blocks,function(n){return n.type==e&&!t.isEmpty(n.getData())});n.length===0&&(this.errors.push({text:"A required block type "+e+" is empty"}),u++,r.log("A required block type "+e+" is empty"))}},this)),this.store("save",this),u>0&&this.renderErrors(),u},renderErrors:function(){if(this.errors.length>0){t.isUndefined(this.$errors)&&(this.$errors=e("<div>",{"class":this.baseCSS("errors"),html:"<p>You have the following errors: </p><ul></ul>"}),this.$outer.prepend(this.$errors));var n=this.$errors.find("ul");t.each(this.errors,t.bind(function(t){n.append(e("<li>",{"class":this.baseCSS("error-msg"),html:t.text}))},this)),this.$errors.show()}},removeErrors:function(){this.errors.length>0&&(this.$errors.find("ul").html(""),this.$errors.hide(),this.errors=[])},_getBlockTypeLimit:function(e){return this._blockTypeAvailable(e)?t.isUndefined(this.options.blockTypeLimits[e])?r.Blocks[e].prototype.limit:this.options.blockTypeLimits[e]:0},_blockTypeAvailable:function(e){return!t.isUndefined(this.blockTypes[e])},_formatterAvailable:function(e){return!t.isUndefined(this.formatters[e])},_ensureAndSetElements:function(){if(t.isUndefined(this.options.el)||t.isEmpty(this.options.el))return r.log("You must provide an el"),!1;this.$el=this.options.el,this.el=this.options.el[0],this.$form=this.$el.parents("form");var n=this.baseCSS("blocks");return this.$el.wrap(e("<div>",{id:this.ID,"class":this.options.baseCSSClass,dropzone:"copy link move"})).wrap(e("<div>",{"class":n})),this.$outer=this.$form.find("#"+this.ID),this.$wrapper=this.$outer.find("."+n),!0},_setBlocksAndFormatters:function(){this.blockTypes=o(t.isUndefined(this.options.blockTypes)?r.Blocks:this.options.blockTypes),this.formatters=o(t.isUndefined(this.options.formatters)?r.Formatters:this.options.formatters)},_setRequired:function(){this.required=t.isArray(this.options.required)&&!t.isEmpty(this.options.required)?this.options.required:!1},_toMarkdown:function(e,n){var i;i=e.replace(/\n/mg,"").replace(/<a.*?href=[""'](.*?)[""'].*?>(.*?)<\/a>/g,"[$2]($1)").replace(/<\/?b>/g,"**").replace(/<\/?STRONG>/g,"**").replace(/<\/?i>/g,"_").replace(/<\/?EM>/g,"_");var s,o;for(s in this.formatters)r.Formatters.hasOwnProperty(s)&&(o=r.Formatters[s],!t.isUndefined(o.toMarkdown)&&t.isFunction(o.toMarkdown)&&(i=o.toMarkdown(i)));i=i.replace(/([^<>]+)(<div>)/g,"$1\n\n$2").replace(/(?:<div>)([^<>]+)(?:<div>)/g,"$1\n\n").replace(/(?:<div>)(?:<br>)?([^<>]+)(?:<br>)?(?:<\/div>)/g,"$1\n\n").replace(/<\/p>/g,"\n\n\n\n").replace(/<(.)?br(.)?>/g,"\n\n").replace(/&nbsp;/g," ").replace(/&lt;/g,"<").replace(/&gt;/g,">");var u;return r.Blocks.hasOwnProperty(n)&&(u=r.Blocks[n],!t.isUndefined(u.prototype.toMarkdown)&&t.isFunction(u.prototype.toMarkdown)&&(i=u.prototype.toMarkdown(i))),i=i.replace(/<\/?[^>]+(>|$)/g,""),i},_toHTML:function(e,n){var i=e,s,o;for(s in this.formatters)r.Formatters.hasOwnProperty(s)&&(o=r.Formatters[s],!t.isUndefined(o.toHTML)&&t.isFunction(o.toHTML)&&(i=o.toHTML(i)));var u;return r.Blocks.hasOwnProperty(n)&&(u=r.Blocks[n],!t.isUndefined(u.prototype.toHTML)&&t.isFunction(u.prototype.toHTML)&&(i=u.prototype.toHTML(i))),i=i.replace(/^\> (.+)$/mg,"$1").replace(/\n\n/g,"<br>").replace(/\[([^\]]+)\]\(([^\)]+)\)/g,"<a href='$2'>$1</a>").replace(/(?:_)([^*|_(http)]+)(?:_)/g,"<i>$1</i>").replace(/(?:\*\*)([^*|_]+)(?:\*\*)/g,"<b>$1</b>"),i},baseCSS:function(e){return this.options.baseCSSClass+"-"+e}}),r.bindFormSubmit=function(e){i||(r.submittable(),e.bind("submit",this.onFormSubmit),i=!0)},r.onBeforeSubmit=function(e){var n=0;return t.each(r.instances,function(t,r){n+=t.onFormSubmit(e)}),r.log("Total errors: "+n),n},r.onFormSubmit=function(e){var t=r.onBeforeSubmit();t>0&&(r.publish("onError"),e.preventDefault())},r.runOnAllInstances=function(e){t.has(r.Editor.prototype,e)?([].unshift.call(arguments,r.instances),t.invoke.apply(t,arguments)):r.log("method doesn't exist")}})(jQuery,_);