(function($,_){var SirTrevor,root=this,array=[];array.push,array.slice,array.splice,SirTrevor=root.SirTrevor={},SirTrevor.DEBUG=!0,SirTrevor.SKIP_VALIDATION=!1,SirTrevor.DEFAULTS={defaultType:"Text",spinner:{className:"st-spinner",lines:9,length:8,width:3,radius:6,color:"#000",speed:1.4,trail:57,shadow:!1,left:"50%",top:"50%"},blockLimit:0,blockTypeLimits:{},required:[],uploadUrl:"/attachments",baseImageUrl:"/sir-trevor-uploads/",twitter:{fetchURL:"/tweets/fetch"}},SirTrevor.BlockMixins={},SirTrevor.Blocks={},SirTrevor.Formatters={},SirTrevor.instances=[],SirTrevor.Events=Eventable;var formBound=!1,FunctionBind={bound:[],_bindFunctions:function(){var args=[];args.push(this),args.join(this.bound),_.bindAll.apply(this,args)}},Renderable={tagName:"div",className:"sir-trevor__view",attributes:{},$:function(selector){return this.$el.find(selector)},render:function(){return this},_ensureElement:function(){if(this.el)this._setElement(this.el);else{var html,attrs=_.extend({},_.result(this,"attributes"));this.id&&(attrs.id=this.id),this.className&&(attrs["class"]=this.className),attrs.html&&(html=attrs.html,delete attrs.html);var $el=$("<"+this.tagName+">").attr(attrs);html&&$el.html(html),this._setElement($el)}},_setElement:function(element){return this.$el=element instanceof jQuery?element:$(element),this.el=this.$el[0],this}};(function($){function dragEnter(e){e.preventDefault()}function dragOver(e){e.originalEvent.dataTransfer.dropEffect="copy",$(e.currentTarget).addClass("st-drag-over"),e.preventDefault()}function dragLeave(e){$(e.currentTarget).removeClass("st-drag-over"),e.preventDefault()}$.fn.dropArea=function(){return this.bind("dragenter",dragEnter).bind("dragover",dragOver).bind("dragleave",dragLeave),this},$.fn.noDropArea=function(){return this.unbind("dragenter").unbind("dragover").unbind("dragleave"),this}})(jQuery);var extend=function(protoProps,staticProps){var child,parent=this;child=protoProps&&_.has(protoProps,"constructor")?protoProps.constructor:function(){return parent.apply(this,arguments)},_.extend(child,parent,staticProps);var Surrogate=function(){this.constructor=child};return Surrogate.prototype=parent.prototype,child.prototype=new Surrogate,protoProps&&_.extend(child.prototype,protoProps),child.__super__=parent.prototype,child};SirTrevor.log=function(message){!_.isUndefined(console)&&SirTrevor.DEBUG&&console.log(message)},function(a,b,c){function g(a,c){var e,d=b.createElement(a||"div");for(e in c)d[e]=c[e];return d}function h(a){for(var b=1,c=arguments.length;c>b;b++)a.appendChild(arguments[b]);return a}function j(a,b,c,d){var g=["opacity",b,~~(100*a),c,d].join("-"),h=.01+100*(c/d),j=Math.max(1-(1-a)/b*(100-h),a),k=f.substring(0,f.indexOf("Animation")).toLowerCase(),l=k&&"-"+k+"-"||"";return e[g]||(i.insertRule("@"+l+"keyframes "+g+"{"+"0%{opacity:"+j+"}"+h+"%{opacity:"+a+"}"+(h+.01)+"%{opacity:1}"+(h+b)%100+"%{opacity:"+a+"}"+"100%{opacity:"+j+"}"+"}",0),e[g]=1),g}function k(a,b){var f,g,e=a.style;if(e[b]!==c)return b;for(b=b.charAt(0).toUpperCase()+b.slice(1),g=0;d.length>g;g++)if(f=d[g]+b,e[f]!==c)return f}function l(a,b){for(var c in b)a.style[k(a,c)||c]=b[c];return a}function m(a){for(var b=1;arguments.length>b;b++){var d=arguments[b];for(var e in d)a[e]===c&&(a[e]=d[e])}return a}function n(a){for(var b={x:a.offsetLeft,y:a.offsetTop};a=a.offsetParent;)b.x+=a.offsetLeft,b.y+=a.offsetTop;return b}var f,d=["webkit","Moz","ms","O"],e={},i=function(){var a=g("style");return h(b.getElementsByTagName("head")[0],a),a.sheet||a.styleSheet}(),o={lines:12,length:7,width:5,radius:10,rotate:0,color:"#000",speed:1,trail:100,opacity:.25,fps:20,zIndex:2e9,className:"spinner",top:"auto",left:"auto"},p=function q(a){return this.spin?(this.opts=m(a||{},q.defaults,o),void 0):new q(a)};p.defaults={},m(p.prototype,{spin:function(a){this.stop();var h,i,b=this,c=b.opts,d=b.el=l(g(0,{className:c.className}),{position:"relative",zIndex:c.zIndex}),e=c.radius+c.length+c.width;if(a&&(a.insertBefore(d,a.firstChild||null),i=n(a),h=n(d),l(d,{left:("auto"==c.left?i.x-h.x+(a.offsetWidth>>1):c.left+e)+"px",top:("auto"==c.top?i.y-h.y+(a.offsetHeight>>1):c.top+e)+"px"})),d.setAttribute("aria-role","progressbar"),b.lines(d,b.opts),!f){var j=0,k=c.fps,m=k/c.speed,o=(1-c.opacity)/(m*c.trail/100),p=m/c.lines;!function q(){j++;for(var a=c.lines;a;a--){var e=Math.max(1-(j+a*p)%m*o,c.opacity);b.opacity(d,c.lines-a,e,c)}b.timeout=b.el&&setTimeout(q,~~(1e3/k))}()}return b},stop:function(){var a=this.el;return a&&(clearTimeout(this.timeout),a.parentNode&&a.parentNode.removeChild(a),this.el=c),this},lines:function(a,b){function e(a,d){return l(g(),{position:"absolute",width:b.length+b.width+"px",height:b.width+"px",background:a,boxShadow:d,transformOrigin:"left",transform:"rotate("+~~(360/b.lines*c+b.rotate)+"deg) translate("+b.radius+"px"+",0)",borderRadius:(b.width>>1)+"px"})}for(var d,c=0;b.lines>c;c++)d=l(g(),{position:"absolute",top:1+~(b.width/2)+"px",transform:b.hwaccel?"translate3d(0,0,0)":"",opacity:b.opacity,animation:f&&j(b.opacity,b.trail,c,b.lines)+" "+1/b.speed+"s linear infinite"}),b.shadow&&h(d,l(e("#000","0 0 4px #000"),{top:"2px"})),h(a,h(d,e(b.color,"0 0 1px rgba(0,0,0,.1)")));return a},opacity:function(a,b,c){a.childNodes.length>b&&(a.childNodes[b].style.opacity=c)}}),!function(){function a(a,b){return g("<"+a+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',b)}var b=l(g("group"),{behavior:"url(#default#VML)"});!k(b,"transform")&&b.adj?(i.addRule(".spin-vml","behavior:url(#default#VML)"),p.prototype.lines=function(b,c){function f(){return l(a("group",{coordsize:e+" "+e,coordorigin:-d+" "+-d}),{width:e,height:e})}function k(b,e,g){h(i,h(l(f(),{rotation:360/c.lines*b+"deg",left:~~e}),h(l(a("roundrect",{arcsize:1}),{width:d,height:c.width,left:c.radius,top:-c.width>>1,filter:g}),a("fill",{color:c.color,opacity:c.opacity}),a("stroke",{opacity:0}))))}var j,d=c.length+c.width,e=2*d,g=2*-(c.width+c.length)+"px",i=l(f(),{position:"absolute",top:g,left:g});if(c.shadow)for(j=1;c.lines>=j;j++)k(j,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(j=1;c.lines>=j;j++)k(j);return h(b,i)},p.prototype.opacity=function(a,b,c,d){var e=a.firstChild;d=d.shadow&&d.lines||0,e&&e.childNodes.length>b+d&&(e=e.childNodes[b+d],e=e&&e.firstChild,e=e&&e.firstChild,e&&(e.opacity=c))}):f=k(b,"animation")}(),a.Spinner=p}(window,document),SirTrevor.blockStore=function(method,block,options){var resp;switch(options=options||{},method){case"create":var data=options.data||{};block.dataStore={type:block.type.toLowerCase(),data:data};break;case"save":options.data&&(block.dataStore.data=options.data,resp=block.dataStore);break;case"read":resp=block.dataStore}return resp?resp:void 0},SirTrevor.editorStore=function(method,editor,options){var resp;switch(options=options||{},method){case"create":var content=_.trim(editor.$el.val());if(editor.dataStore={data:[]},content.length>0)try{var str=JSON.parse(content);_.isUndefined(str.data)||(editor.dataStore=str)}catch(e){console.log("Sorry there has been a problem with parsing the JSON"),console.log(e)}break;case"reset":editor.dataStore={data:[]};break;case"add":options.data&&(editor.dataStore.data.push(options.data),resp=editor.dataStore);break;case"save":editor.$el.val(editor.dataStore.data.length>0?JSON.stringify(editor.dataStore):"");break;case"read":resp=editor.dataStore}return resp?resp:void 0};var Submittable=function(){this.intialize()};_.extend(Submittable.prototype,{intialize:function(){this.submitBtn=$("input[type='submit']");var btnTitles=[];_.each(this.submitBtn,function(btn){btnTitles.push($(btn).attr("value"))}),this.submitBtnTitles=btnTitles,this.canSubmit=!0,this.globalUploadCount=0,this._bindEvents()},setSubmitButton:function(e,message){this.submitBtn.attr("value",message)},resetSubmitButton:function(){_.each(this.submitBtn,_.bind(function(item,index){$(item).attr("value",this.submitBtnTitles[index])},this))},onUploadStart:function(){this.globalUploadCount++,SirTrevor.log("onUploadStart called "+this.globalUploadCount),1===this.globalUploadCount&&this._disableSubmitButton()},onUploadStop:function(){this.globalUploadCount=0>=this.globalUploadCount?0:this.globalUploadCount-1,SirTrevor.log("onUploadStop called "+this.globalUploadCount),0===this.globalUploadCount&&this._enableSubmitButton()},onError:function(){SirTrevor.log("onError called"),this.canSubmit=!1},_disableSubmitButton:function(message){this.setSubmitButton(null,message||"Please wait..."),this.submitBtn.attr("disabled","disabled").addClass("disabled")},_enableSubmitButton:function(){this.resetSubmitButton(),this.submitBtn.removeAttr("disabled").removeClass("disabled")},_events:{disableSubmitButton:"_disableSubmitButton",enableSubmitButton:"_enableSubmitButton",setSubmitButton:"setSubmitButton",resetSubmitButton:"resetSubmitButton",onError:"onError",onUploadStart:"onUploadStart",onUploadStop:"onUploadStop"},_bindEvents:function(){_.forEach(this._events,function(callback,type){SirTrevor.EventBus.on(type,this[callback],this)},this)}}),SirTrevor.submittable=function(){new Submittable},SirTrevor.fileUploader=function(block,file,success,error){SirTrevor.EventBus.trigger("onUploadStart");var uid=[block.ID,(new Date).getTime(),"raw"].join("-"),data=new FormData;data.append("attachment[name]",file.name),data.append("attachment[file]",file),data.append("attachment[uid]",uid);var callbackSuccess=function(data){!_.isUndefined(success)&&_.isFunction(success)&&(SirTrevor.log("Upload callback called"),SirTrevor.EventBus.trigger("onUploadStop"),_.bind(success,block)(data))},callbackError=function(jqXHR,status){!_.isUndefined(error)&&_.isFunction(error)&&(SirTrevor.log("Upload callback error called"),SirTrevor.EventBus.trigger("onUploadError"),_.bind(error,block)(status))};$.ajax({url:SirTrevor.DEFAULTS.uploadUrl,data:data,cache:!1,contentType:!1,processData:!1,type:"POST",success:callbackSuccess,error:callbackError})};var url_regex=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/;_.mixin({isURI:function(string){return url_regex.test(string)},capitalize:function(string){return string.charAt(0).toUpperCase()+string.substring(1).toLowerCase()},trim:function(string){return string.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},flattern:function(obj){var x={};return _.each(obj,function(a,b){x[_.isArray(obj)?a:b]=!0}),x},to_slug:function(str){return str.toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"-")}}),SirTrevor.toHTML=function(markdown,type){var formatName,format,html=markdown;for(formatName in this.formatters)SirTrevor.Formatters.hasOwnProperty(formatName)&&(format=SirTrevor.Formatters[formatName],!_.isUndefined(format.toHTML)&&_.isFunction(format.toHTML)&&(html=format.toHTML(html)));var block;return SirTrevor.Blocks.hasOwnProperty(type)&&(block=SirTrevor.Blocks[type],!_.isUndefined(block.prototype.toHTML)&&_.isFunction(block.prototype.toHTML)&&(html=block.prototype.toHTML(html))),html=html.replace(/^\> (.+)$/gm,"$1").replace(/\n\n/g,"<br>").replace(/\[([^\]]+)\]\(([^\)]+)\)/g,"<a href='$2'>$1</a>").replace(/(?:_)([^*|_(http)]+)(?:_)/g,"<i>$1</i>").replace(/(?:\*\*)([^*|_]+)(?:\*\*)/g,"<b>$1</b>")},SirTrevor.toMarkdown=function(content,type){var markdown;markdown=content.replace(/\n/gm,"").replace(/<a.*?href=[""'](.*?)[""'].*?>(.*?)<\/a>/g,"[$2]($1)").replace(/<\/?b>/g,"**").replace(/<\/?STRONG>/g,"**").replace(/<\/?i>/g,"_").replace(/<\/?EM>/g,"_");var formatName,format;for(formatName in this.formatters)SirTrevor.Formatters.hasOwnProperty(formatName)&&(format=SirTrevor.Formatters[formatName],!_.isUndefined(format.toMarkdown)&&_.isFunction(format.toMarkdown)&&(markdown=format.toMarkdown(markdown)));markdown=markdown.replace(/([^<>]+)(<div>)/g,"$1\n\n$2").replace(/(?:<div>)([^<>]+)(?:<div>)/g,"$1\n\n").replace(/(?:<div>)(?:<br>)?([^<>]+)(?:<br>)?(?:<\/div>)/g,"$1\n\n").replace(/<\/p>/g,"\n\n\n\n").replace(/<(.)?br(.)?>/g,"\n\n").replace(/&nbsp;/g," ").replace(/&lt;/g,"<").replace(/&gt;/g,">");var block;return SirTrevor.Blocks.hasOwnProperty(type)&&(block=SirTrevor.Blocks[type],!_.isUndefined(block.prototype.toMarkdown)&&_.isFunction(block.prototype.toMarkdown)&&(markdown=block.prototype.toMarkdown(markdown))),markdown=markdown.replace(/<\/?[^>]+(>|$)/g,"")},SirTrevor.EventBus=_.extend({},SirTrevor.Events),SirTrevor.BlockMixins.Droppable={name:"Droppable",valid_drop_file_types:["File","Files","text/plain","text/uri-list"],initializeDroppable:function(){SirTrevor.log("Adding drag and drop capabilities for block "+this.blockID);var drop_options=_.extend(default_drop_options,this.drop_options),drop_html=$(_.template(drop_options.drop_html,this));this.drop_options.pastable&&drop_html.append(drop_options.paste_html),this.drop_options.uploadable&&drop_html.append(drop_options.upload_html),this.$editor.hide(),this.$inner.append(drop_html).addClass("st-block__inner--droppable"),this.$dropzone=drop_html,this.$dropzone.dropArea().bind("drop",_.bind(this._handleDrop,this))},_handleDrop:function(e){e.preventDefault(),e=e.originalEvent,SirTrevor.EventBus.trigger("editor/block/handleDrop");var el=$(e.target),types=e.dataTransfer.types;el.removeClass("st-dropzone--dragover"),!_.isUndefined(types)&&_.some(types,function(type){return _.include(this.valid_drop_file_types,type)},this)&&this.onDrop(e.dataTransfer),SirTrevor.EventBus.trigger("block:content:dropped")}};var BlockReorder=SirTrevor.BlockReorder=function(block_element){this.$block=block_element,this._ensureElement(),this._bindFunctions(),this.initialize()};_.extend(BlockReorder.prototype,FunctionBind,Renderable,{bound:["onDragStart","onDragEnd","onDrag","onDrop"],className:"st-block__reorder st-icon",tagName:"a",attributes:function(){return{html:"reorder",draggable:"true","data-icon":"move"}},initialize:function(){this.$el.bind("dragstart",this.onDragStart).bind("dragend touchend",this.onDragEnd).bind("drag touchmove",this.onDrag),this.$block.dropArea().bind("drop",this.onDrop)},onDrop:function(ev){ev.preventDefault();var dropped_on=this.$block,item_id=ev.originalEvent.dataTransfer.getData("text/plain"),block=$("#"+item_id);_.isUndefined(item_id)||_.isEmpty(block)||dropped_on.attr("id")==item_id||dropped_on.attr("data-instance")!=block.attr("data-instance")||dropped_on.after(block),SirTrevor.EventBus.trigger("block:reorder:dropped",item_id)},onDragStart:function(ev){var item=$(ev.target),block=item.parents(".st-block");ev.originalEvent.dataTransfer.setDragImage(block[0],0,0),ev.originalEvent.dataTransfer.setData("Text",block.attr("id")),SirTrevor.EventBus.trigger("block:reorder:dragstart"),block.addClass("st-block--dragging")},onDragEnd:function(ev){var item=$(ev.target),block=item.parents(".st-block");SirTrevor.EventBus.trigger("block:reorder:dragend"),block.removeClass("st-block--dragging")},onDrag:function(){},render:function(){return this}});var BlockDeletion=SirTrevor.BlockDeletion=function(){this._ensureElement(),this._bindFunctions()};_.extend(BlockDeletion.prototype,FunctionBind,Renderable,{tagName:"a",className:"st-block__remove st-icon",attributes:{html:"delete","data-icon":"bin"}});var Block=SirTrevor.Block=function(data,instance_id){this.store("create",this,{data:data||{}}),this.blockID=_.uniqueId("st-block-"),this.instanceID=instance_id,this._ensureElement(),this._bindFunctions(),this.initialize.apply(this,arguments)},default_drop_options={uploadable:!1,pastable:!1,re_render_on_reorder:!1,drop_html:'<div class="st-block__dropzone"><span class="st-icon"><%= icon_name() %></span><p>Drag <span><%= type %></span> here</p></div>',upload_html:'<div class="st-block__upload-container"><input type="file" type="st-file-upload" /><button class="st-upload-btn">...or choose a file</button></div>',paste_html:'<input type="text" placeholder="Or paste URL here" class="st-block__paste-input st-paste-block">'};_.extend(Block.prototype,FunctionBind,SirTrevor.Events,Renderable,{bound:["_handleDrop","_handleContentPaste","_onFocus","_onBlur","onDrop","onDeleteClick"],className:"st-block st-icon--add",block_template:_.template("<div class='st-block__inner'><%= editor_html %></div>"),drop_options:default_drop_options,attributes:function(){return{id:this.blockID,"data-type":this.type,"data-instance":this.instanceID,"data-icon":"add"}},title:function(){return _.capitalize(this.type)},icon_name:function(){return this.type.toLowerCase()},blockCSSClass:function(){return this.blockCSSClass=_.to_slug(this.type),this.blockCSSClass},validationFailMsg:function(){return this.type+" block is invalid"},$$:function(selector){return this.$el.find(selector)},type:"",editorHTML:'<div class="st-block__editor"></div>',toolbarEnabled:!0,droppable:!1,formattable:!0,formattingEnabled:!0,uploadsCount:0,initialize:function(){},loadData:function(){},onBlockRender:function(){},beforeBlockRender:function(){},toMarkdown:function(markdown){return markdown},toHTML:function(html){return html},store:function(){return SirTrevor.blockStore.apply(this,arguments)},_loadAndSetData:function(){var currentData=this.getData();_.isUndefined(currentData)||_.isEmpty(currentData)||this._loadData()},withMixin:function(mixin){_.isObject(mixin)&&(_.extend(this,mixin),this["initialize"+mixin.name]())},render:function(){this.beforeBlockRender();var editor_html=_.result(this,"editorHTML");return this.$el.append(this.block_template({editor_html:editor_html})),this.$inner=this.$el.find(".st-block__inner"),this.$editor=this.$inner.children().first(),this.$inner.bind("click mouseover",function(e){e.stopPropagation()}),this.hasTextBlock&&this._initTextBlocks(),this.droppable&&this.withMixin(SirTrevor.BlockMixins.Droppable),this.formattingEnabled&&this._initFormatting(),this._loadAndSetData(),this._initUIComponents(),this._initPaste(),this.$el.addClass("st-item-ready"),this.save(),this.onBlockRender(),this},remove:function(){this.$el.remove()},save:function(){return this.toData(),this.store("read",this)},getData:function(){return this.store("read",this).data},setData:function(data){SirTrevor.log("Setting data for block "+this.blockID),this.store("save",this,{data:_.extend(this.dataStore.data,data)})},loading:function(){_.isUndefined(this.spinner)||this.ready(),this.spinner=new Spinner(SirTrevor.DEFAULTS.spinner),this.spinner.spin(this.$el[0]),this.$el.addClass("st--is-loading")},ready:function(){this.$el.removeClass("st--is-loading"),_.isUndefined(this.spinner)||(this.spinner.stop(),delete this.spinner)},validate:function(){this._beforeValidate();var fields=this.$$(".st-required, [data-maxlength]"),errors=0;return _.each(fields,_.bind(function(field){field=$(field);var content=field.attr("contenteditable")?field.text():field.val(),too_long=field.attr("data-maxlength")&&field.too_long(),required=field.hasClass("st-required");(required&&0===content.length||too_long)&&(field.addClass("st-error"),errors++)},this)),errors>0&&this.$el.addClass("st-block--with-errors"),0===errors},toData:function(){SirTrevor.log("toData for "+this.blockID);var dataObj=(this.$el,{});if(this.$$(".st-text-block").length>0){var content=this.$$(".st-text-block").html();content.length>0&&(dataObj.text=SirTrevor.toMarkdown(content,this.type))}var hasTextAndData=!_.isUndefined(dataObj.text)||0===this.$$(".st-text-block").length;this.$$('input[type="text"]').not(".st-paste-block").length>0&&this.$$('input[type="text"]').each(function(index,input){input=$(input),hasTextAndData&&(dataObj[input.attr("name")]=input.val())}),this.$$("select").each(function(index,input){input=$(input),input.val().length>0&&hasTextAndData&&(dataObj[input.attr("name")]=input.val())}),_.isEmpty(dataObj)||this.setData(dataObj)},focus:function(){this.$(".st-text-block").focus()},blur:function(){this.$(".st-text-block").blur()},onFocus:function(){this.$(".st-text-block").bind("focus",this._onFocus)},onBlur:function(){this.$(".st-text-block").bind("blur",this._onBlur)},_onFocus:function(){this.trigger("blockFocus",this.$el)},_onBlur:function(){},onDrop:function(){},onDeleteClick:function(ev){ev.preventDefault(),confirm("Are you sure you wish to delete this content?")&&(this.remove(),this.trigger("removeBlock",this.blockID,this.type))},onContentPasted:function(){var textBlock=this.$$(".st-text-block");textBlock.length>0&&textBlock.html(SirTrevor.toHTML(SirTrevor.toMarkdown(textBlock.html(),this.type),this.type))},uploader:function(file,callback){SirTrevor.fileUploader(this,file,callback)},_loadData:function(){SirTrevor.log("loadData for "+this.blockID),this.loading(),this.droppable&&(this.$editor.show(),this.$dropzone.hide()),SirTrevor.EventBus.trigger("editor/block/loadData"),this.loadData(this.getData()),this.ready()},_beforeValidate:function(){this.errors=[];var errorClass="st-error";this.$el.removeClass("st-block--with-errors"),this.$("."+errorClass).removeClass(errorClass)},_handleContentPaste:function(ev){var timed=function(ev){this.onContentPasted(ev)};_.delay(_.bind(timed,this,ev),100)},_getBlockClass:function(){return"st-block--"+this.className},_initUIComponents:function(){var ui_element=$("<div>",{"class":"st-block__ui"});this.$inner.append(ui_element),this.$ui=ui_element,this.$ui.append(new SirTrevor.BlockReorder(this.$el).render().$el),this.$ui.append((new SirTrevor.BlockDeletion).render().$el),this.$ui.on("click",".st-block__remove",this.onDeleteClick),this.onFocus(),this.onBlur()},_initFormatting:function(){var formatter;for(var name in SirTrevor.Formatters)SirTrevor.Formatters.hasOwnProperty(name)&&(formatter=SirTrevor.Formatters[name],_.isUndefined(formatter.keyCode)||formatter._bindToBlock(this.$el))},_initTextBlocks:function(){var shift_down=!1;this.$$(".st-text-block").bind("paste",this._handleContentPaste).bind("keydown",function(e){var code=e.keyCode?e.keyCode:e.which;16==code&&(shift_down=!0)}).bind("keyup",_.bind(function(e){var code=e.keyCode?e.keyCode:e.which;!shift_down||37!=code&&39!=code&&40!=code&&38!=code||this.getSelectionForFormatter(),16==code&&(shift_down=!1)},this)).bind("mouseup",this.getSelectionForFormatter)},getSelectionForFormatter:function(){var range=window.getSelection().getRangeAt(0),rects=range.getClientRects();!range.collapsed&&rects.length?SirTrevor.EventBus.trigger("formatter:positon",rects):SirTrevor.EventBus.trigger("formatter:hide")},hasTextBlock:function(){return this.$(".st-text-block").length>0},_initPaste:function(){this.$(".st-paste-block").bind("click",function(){$(this).select()}).bind("paste",this._handleContentPaste).bind("submit",this._handleContentPaste)}}),Block.extend=extend;var Format=SirTrevor.Formatter=function(options){this.formatId=_.uniqueId("format-"),this._configure(options||{}),this.initialize.apply(this,arguments)},formatOptions=["title","className","cmd","keyCode","param","onClick","toMarkdown","toHTML"];_.extend(Format.prototype,{title:"",className:"",cmd:null,keyCode:null,param:null,toMarkdown:function(markdown){return markdown},toHTML:function(html){return html},initialize:function(){},_configure:function(options){this.options&&(options=_.extend({},this.options,options));for(var i=0,l=formatOptions.length;l>i;i++){var attr=formatOptions[i];options[attr]&&(this[attr]=options[attr])}this.options=options},_bindToBlock:function(block){var formatter=this,ctrlDown=!1;block.on("keyup",".st-text-block",function(ev){(17==ev.which||224==ev.which)&&(ctrlDown=!1)}).on("keydown",".st-text-block",{formatter:formatter},function(ev){(17==ev.which||224==ev.which)&&(ctrlDown=!0),ev.which==ev.data.formatter.keyCode&&ctrlDown===!0&&(document.execCommand(ev.data.formatter.cmd,!1,!0),ev.preventDefault())})}}),Format.extend=extend,SirTrevor.Blocks.Quote=SirTrevor.Block.extend({type:"Quote",editorHTML:function(){return _.template('<blockquote class="st-required st-text-block <%= className %>" contenteditable="true"></blockquote>          <input maxlength="140" name="cite" placeholder="Credit" class="st-input-string st-required" type="text" />',this)},loadData:function(data){this.$$(".st-text-block").html(SirTrevor.toHTML(data.text,this.type)),this.$$("input").val(data.cite)},toMarkdown:function(markdown){return markdown.replace(/^(.+)$/gm,"> $1")}}),SirTrevor.Blocks.Gallery=SirTrevor.Block.extend({type:"Gallery",droppable:!0,drop_options:{uploadable:!0,upload_html:'<div class="st-block__upload-container"><input type="file" multiple="true" type="st-file-upload" /><button class="st-upload-btn">...or choose a file</button></div>'},editorHTML:'<div class="gallery-items"><p>Gallery Contents:</p><ul></ul></div>',loadData:function(data){_.isArray(data)&&(_.each(data,_.bind(function(item){this.renderGalleryThumb(item)},this)),this.$dropzone.show())},renderGalleryThumb:function(item){if(_.isUndefined(item.data.file))return!1;var img=$("<img>",{src:item.data.file.thumb.url}),list=$("<li>",{id:_.uniqueId("gallery-item"),"class":"gallery-item",html:img});list.append($("<span>",{"class":"delete",click:_.bind(function(e){e.preventDefault(),confirm("Are you sure you wish to delete this image?")&&($(e.target).parent().remove(),this.reindexData())},this)})),list.data("block",item),this.$$("ul").append(list),list.dropArea().bind("dragstart",_.bind(function(ev){var item=$(ev.target);ev.originalEvent.dataTransfer.setData("Text",item.parent().attr("id")),item.parent().addClass("dragging")},this)).bind("drag",_.bind(function(){},this)).bind("dragend",_.bind(function(ev){var item=$(ev.target);item.parent().removeClass("dragging")},this)).bind("dragover",_.bind(function(ev){var item=$(ev.target);item.parents("li").addClass("dragover")},this)).bind("dragleave",_.bind(function(ev){var item=$(ev.target);item.parents("li").removeClass("dragover")},this)).bind("drop",_.bind(function(ev){var item=$(ev.target),parent=item.parent();item=item.hasClass("gallery-item")?item:parent,this.$$("ul li.dragover").removeClass("dragover");var target=$("#"+ev.originalEvent.dataTransfer.getData("text/plain"));return target.attr("id")===item.attr("id")?!1:(target.length>0&&target.hasClass("gallery-item")&&item.before(target),this.reindexData(),void 0)},this))},onBlockRender:function(){this.$dropzone.find("button").bind("click",function(ev){ev.preventDefault()}),this.$dropzone.find("input").on("change",_.bind(function(ev){this.onDrop(ev.currentTarget)},this))},reindexData:function(){var dataStruct=this.getData();dataStruct=[],_.each(this.$$("li.gallery-item"),function(li){li=$(li),dataStruct.push(li.data("block"))}),this.setData(dataStruct)},onDrop:function(transferData){if(transferData.files.length>0){var file,l=transferData.files.length;for(this.loading();l--;)file=transferData.files[l],/image/.test(file.type)&&(this.uploadsCount+=1,this.$editor.show(),this.uploader(file,function(data){this.uploadsCount-=1;var dataStruct=this.getData();data={type:"image",data:data},_.isArray(dataStruct)||(dataStruct=[]),dataStruct.push(data),this.setData(dataStruct),this.renderGalleryThumb(data),0===this.uploadsCount&&this.ready()}))}}}),SirTrevor.Blocks.Heading=SirTrevor.Block.extend({type:"Heading",editorHTML:'<h1 class="st-required st-text-block" contenteditable="true"></h1>',loadData:function(data){this.$$(".st-text-block").html(SirTrevor.toHTML(data.text,this.type))}}),SirTrevor.Blocks.Image=SirTrevor.Block.extend({type:"Image",droppable:!0,drop_options:{uploadable:!0},loadData:function(data){this.$editor.html($("<img>",{src:data.file.url}))},onBlockRender:function(){this.$dropzone.find("button").bind("click",function(ev){ev.preventDefault()}),this.$dropzone.find("input").on("change",_.bind(function(ev){this.onDrop(ev.currentTarget)},this))},onDrop:function(transferData){var file=transferData.files[0],urlAPI="undefined"!=typeof URL?URL:"undefined"!=typeof webkitURL?webkitURL:null;/image/.test(file.type)&&(this.loading(),this.$dropzone.hide(),this.$editor.html($("<img>",{src:urlAPI.createObjectURL(file)})).show(),SirTrevor.EventBus.trigger("setSubmitButton",["Please wait..."]),this.uploader(file,function(data){this.setData(data),this.ready()},function(){alert("Error!")}))}}),SirTrevor.Blocks.Text=SirTrevor.Block.extend({type:"Text",editorHTML:'<div class="st-required st-text-block" contenteditable="true"></div>',loadData:function(data){this.$$(".st-text-block").html(SirTrevor.toHTML(data.text,this.type))}});var tweet_template=_.template(["<blockquote class='twitter-tweet' align='center'>","<p><%= text %></p>","&mdash; <%= user.name %> (@<%= user.screen_name %>)","<a href='<%= status_url %>' data-datetime='<%= created_at %>'><%= created_at %></a>","</blockquote>",'<script src="//platform.twitter.com/widgets.js" charset="utf-8"></script>'].join("\n"));SirTrevor.Blocks.Tweet=SirTrevor.Block.extend({type:"Tweet",droppable:!0,drop_options:{pastable:!0,re_render_on_reorder:!0},icon_name:function(){return"twitter"},default_data:{text:"",user:{name:"",screen_name:""},status_url:"",created_at:""},loadData:function(data){_.isUndefined(data.status_url)&&(data.status_url=""),this.$inner.find("iframe").remove(),this.$inner.prepend(tweet_template(data))},onContentPasted:function(event){var input=$(event.target),val=input.val();this.handleTwitterDropPaste(val)},handleTwitterDropPaste:function(url){if(_.isURI(url)&&-1!=url.indexOf("twitter")&&-1!=url.indexOf("status")){var tweetID=url.match(/[^\/]+$/);if(!_.isEmpty(tweetID)){this.loading(),tweetID=tweetID[0];var tweetCallbackSuccess=function(data){var obj={user:{profile_image_url:data.user.profile_image_url,profile_image_url_https:data.user.profile_image_url_https,screen_name:data.user.screen_name,name:data.user.name},id:data.id_str,text:data.text,created_at:data.created_at,status_url:url};this.setData(obj),this._loadData(),this.ready()},tweetCallbackFail=function(){this.ready()};$.ajax({url:SirTrevor.DEFAULTS.twitter.fetchURL+"?tweet_id="+tweetID,dataType:"json",success:_.bind(tweetCallbackSuccess,this),error:_.bind(tweetCallbackFail,this)})}}},onDrop:function(transferData){var url=transferData.getData("text/plain");this.handleTwitterDropPaste(url)}});var template='<ul class="st-text-block" contenteditable="true"><li></li></ul>';SirTrevor.Blocks.List=SirTrevor.Block.extend({type:"List",editorHTML:function(){return _.template(template,this)},loadData:function(data){this.$$(".st-text-block").html("<ul>"+SirTrevor.toHTML(data.text,this.type)+"</ul>")},toMarkdown:function(markdown){return markdown.replace(/<\/li>/gm,"\n").replace(/<\/?[^>]+(>|$)/g,"").replace(/^(.+)$/gm," - $1")},toHTML:function(html){return html=html.replace(/^ - (.+)$/gm,"<li>$1</li>").replace(/\n/gm,""),"<ul>"+html+"</ul>"}});var video_regex=/http[s]?:\/\/(?:www.)?(?:(vimeo).com\/(.*))|(?:(youtu(?:be)?).(?:be|com)\/(?:watch\?v=)?([^&]*)(?:&(?:.))?)/;SirTrevor.Blocks.Video=SirTrevor.Block.extend({type:"Video",droppable:!0,drop_options:{pastable:!0},loadData:function(data){this.$editor.addClass("st-block__editor--with-sixteen-by-nine-media"),"youtube"==data.source||"youtu"==data.source?this.$editor.html('<iframe src="'+window.location.protocol+"//www.youtube.com/embed/"+data.remote_id+'" width="580" height="320" frameborder="0" allowfullscreen></iframe>'):"vimeo"==data.source&&this.$editor.html('<iframe src="'+window.location.protocol+"//player.vimeo.com/video/"+data.remote_id+'?title=0&byline=0" width="580" height="320" frameborder="0"></iframe>')},onContentPasted:function(event){var input=$(event.target),val=input.val();this.handleDropPaste(val)},handleDropPaste:function(url){if(_.isURI(url)&&(-1!=url.indexOf("youtu")||-1!=url.indexOf("vimeo"))){var data={},videos=url.match(video_regex);void 0!==videos[3]?(data.source=videos[3],data.remote_id=videos[4]):void 0!==videos[1]&&(data.source=videos[1],data.remote_id=videos[2]),"youtu"==data.source&&(data.source="youtube"),this.setData(data),this._loadData()}},onDrop:function(transferData){var url=transferData.getData("text/plain");this.handleDropPaste(url)}});var Bold=SirTrevor.Formatter.extend({title:"bold",cmd:"bold",keyCode:66,text:"B"}),Italic=SirTrevor.Formatter.extend({title:"italic",cmd:"italic",keyCode:73,text:"i"}),Underline=SirTrevor.Formatter.extend({title:"underline",cmd:"underline",text:"U"}),Link=SirTrevor.Formatter.extend({title:"link",iconName:"link",cmd:"CreateLink",text:"link",onClick:function(){var link=prompt("Enter a link"),link_regex=/(ftp|http|https):\/\/./;
link&&link.length>0&&(link_regex.test(link)||(link="http://"+link),document.execCommand(this.cmd,!1,link))}}),UnLink=SirTrevor.Formatter.extend({title:"unlink",iconName:"link",cmd:"unlink",text:"link"});SirTrevor.Formatters.Bold=new Bold,SirTrevor.Formatters.Italic=new Italic,SirTrevor.Formatters.Underline=new Underline,SirTrevor.Formatters.Link=new Link,SirTrevor.Formatters.Unlink=new UnLink;var BlockControl=SirTrevor.BlockControl=function(type,instance_scope){this.type=type,this.instance_scope=instance_scope,this._ensureElement(),this.initialize()};_.extend(BlockControl.prototype,FunctionBind,Renderable,SirTrevor.Events,{tagName:"a",className:"st-block-control",attributes:function(){return{"data-type":this.type}},initialize:function(){this.block_type=SirTrevor.Blocks[this.type].prototype,this.can_be_rendered=this.block_type.toolbarEnabled},render:function(){return this.$el.html('<span class="st-icon">'+this.block_type.icon_name()+"</span>"+_.result(this.block_type,"title")),this}});var BlockControls=SirTrevor.BlockControls=function(available_types,instance_scope){this.instance_scope=instance_scope,this.available_types=available_types||[],this._ensureElement(),this._bindFunctions(),this.initialize()};_.extend(BlockControls.prototype,FunctionBind,Renderable,SirTrevor.Events,{bound:["handleControlButtonClick"],block_controls:null,className:"st-block-controls",html:"<a class='st-icon st-icon--close'>close</a>",initialize:function(){for(var block_type in this.available_types)if(SirTrevor.Blocks.hasOwnProperty(block_type)){var block_control=new SirTrevor.BlockControl(block_type,this.instance_scope);block_control.can_be_rendered&&this.$el.append(block_control.render().$el)}this.$el.delegate(".st-block-control","click",this.handleControlButtonClick)},show:function(){this.$el.addClass("st-block-controls--active")},hide:function(){this.$el.removeClass("st-block-controls--active")},handleControlButtonClick:function(e){this.trigger("createBlock",e.currentTarget.dataset.type),this.hide()}});var FloatingBlockControls=SirTrevor.FloatingBlockControls=function(wrapper){this.$wrapper=wrapper,this._bindFunctions(),this.initialize()};_.extend(FloatingBlockControls.prototype,FunctionBind,SirTrevor.Events,{bound:["handleWrapperMouseOver","handleBlockMouseOut","handleBlockClick"],initialize:function(){this.$wrapper.on("mouseover",".st-block",this.handleBlockMouseOver),this.$wrapper.on("click",".st-block--with-plus",this.handleBlockClick),this.$wrapper.on("mouseout",".st-block",this.handleBlockMouseOut)},handleBlockMouseOver:function(e){var block=$(e.currentTarget);block.hasClass("st-block--with-plus")||block.addClass("st-block--with-plus")},handleBlockMouseOut:function(e){var block=$(e.currentTarget);block.hasClass("st-block--with-plus")&&block.removeClass("st-block--with-plus")},handleBlockClick:function(e){e.stopPropagation();var block=$(e.currentTarget);this.trigger("showBlockControls",block)}});var FormatBar=SirTrevor.FormatBar=function(options){this.options=_.extend({},SirTrevor.DEFAULTS.formatBar,options||{}),this._ensureElement(),this._bindFunctions(),this.initialize.apply(this,arguments)};_.extend(FormatBar.prototype,FunctionBind,SirTrevor.Events,Renderable,{className:"st-format-bar",bound:["onFormatButtonClick"],initialize:function(){var formatName,format;for(formatName in SirTrevor.Formatters)SirTrevor.Formatters.hasOwnProperty(formatName)&&(format=SirTrevor.Formatters[formatName],$("<button>",{"class":"st-format-btn st-format-btn--"+formatName+" "+(format.iconName?"st-icon":""),text:format.text,"data-type":formatName,"data-cmd":format.cmd}).appendTo(this.$el));this.$b=$(document.body),this.$el.bind("click",".st-format-btn",this.onFormatButtonClick)},hide:function(){this.$el.removeClass("st-format-bar--is-ready")},show:function(){this.$el.addClass("st-format-bar--is-ready")},remove:function(){this.$el.remove()},render_by_selection:function(rectangles){var coords={},width=this.$el.width();if(1==rectangles.length)coords={left:rectangles[0].left+(rectangles[0].width-width)/2,top:rectangles[0].top+this.$b.scrollTop()};else{var max_width=_.max(rectangles,function(rect){return rect.width});coords={left:max_width.width/2,top:rectangles[0].top+this.$b.scrollTop()}}this.show(),this.$el.css(coords)},onFormatButtonClick:function(ev){ev.stopPropagation();var btn=$(ev.target),format=SirTrevor.Formatters[btn.attr("data-type")];return!_.isUndefined(format.onClick)&&_.isFunction(format.onClick)?format.onClick():document.execCommand(btn.attr("data-cmd"),!1,format.param),!1}});var SirTrevorEditor=SirTrevor.Editor=function(options){return SirTrevor.log("Init SirTrevor.Editor"),this.blockTypes={},this.blockCounts={},this.blocks=[],this.errors=[],this.options=_.extend({},SirTrevor.DEFAULTS,options||{}),this.ID=_.uniqueId("st-editor-"),this._ensureAndSetElements()?(!_.isUndefined(this.options.onEditorRender)&&_.isFunction(this.options.onEditorRender)&&(this.onEditorRender=this.options.onEditorRender),this._setRequired(),this._setBlocksTypes(),this._bindFunctions(),this.store("create",this),this.build(),SirTrevor.instances.push(this),SirTrevor.bindFormSubmit(this.$form),void 0):!1};_.extend(SirTrevorEditor.prototype,FunctionBind,SirTrevor.Events,{bound:["onFormSubmit","showBlockControls","hideAllTheThings"],initialize:function(){},build:function(){this.$el.hide(),this.block_controls=new SirTrevor.BlockControls(this.blockTypes,this.ID),this.fl_block_controls=new SirTrevor.FloatingBlockControls(this.$wrapper),this.formatBar=new SirTrevor.FormatBar(this.options.formatBar),this.listenTo(this.block_controls,"createBlock",this.createBlock),this.listenTo(this.fl_block_controls,"showBlockControls",this.showBlockControls),SirTrevor.EventBus.on("block:reorder:dragstart",this.hideBlockControls),SirTrevor.EventBus.on("block:reorder:dragend",this.removeBlockDragOver),SirTrevor.EventBus.on("block:content:dropped",this.removeBlockDragOver),SirTrevor.EventBus.on("block:reorder:dropped",this.onBlockDropped),SirTrevor.EventBus.on("formatter:positon",this.formatBar.render_by_selection),SirTrevor.EventBus.on("formatter:hide",this.formatBar.hide),this.$outer.append(this.formatBar.render().$el),this.$outer.append(this.block_controls.render().$el),$(window).bind("click",this.hideAllTheThings);var store=this.store("read",this);0===store.data.length?this.createBlock(this.options.defaultType):_.each(store.data,_.bind(function(block){SirTrevor.log("Creating: ",block),this.createBlock(block.type,block.data)},this)),this.$wrapper.addClass("st-ready"),_.isUndefined(this.onEditorRender)||this.onEditorRender()},hideAllTheThings:function(){this.block_controls.hide(),this.formatBar.hide(),_.isUndefined(this.block_controls.current_container)||this.block_controls.current_container.removeClass("st-block--with-controls")},showBlockControls:function(container){_.isUndefined(this.block_controls.current_container)||this.block_controls.current_container.removeClass("st-block--with-controls"),this.block_controls.show(),container.append(this.block_controls.$el.detach()),container.addClass("st-block--with-controls"),this.block_controls.current_container=container},store:function(){return SirTrevor.editorStore.apply(this,arguments)},createBlock:function(type,data){if(type=_.capitalize(type),this._blockLimitReached())return SirTrevor.log("Cannot add any more blocks. Limit reached."),!1;if(!this._isBlockTypeAvailable(type))return SirTrevor.log("Block type not available "+type),!1;if(!this._canAddBlockType(type))return SirTrevor.log("Block Limit reached for type "+type),!1;var block=new SirTrevor.Blocks[type](data,this.ID);this._renderInPosition(block.render().$el),this.listenTo(block,"removeBlock",this.removeBlock),this.blocks.push(block),this._incrementBlockTypeCount(type),block.focus(),SirTrevor.EventBus.trigger("editor/block/createBlock"),SirTrevor.log("Block created of type "+type)},blockFocus:function(){this.block_controls.current_container=null},hideBlockControls:function(){this.block_controls.hide()},removeBlockDragOver:function(){this.$wrapper.find(".st-drag-over").removeClass("st-drag-over")},onBlockDropped:function(block_id){this.hideAllTheThings();var block=this.findBlockById(block_id);!_.isUndefined(block)&&block.dataStore.data.length>0&&block.drop_options.re_render_on_reorder&&block._loadData(block.dataStore)},_renderInPosition:function(block){this.block_controls.current_container?this.block_controls.current_container.after(block):this.$wrapper.append(block)},_incrementBlockTypeCount:function(type){this.blockCounts[type]=_.isUndefined(this.blockCounts[type])?1:this.blockCounts[type]+1},_getBlockTypeCount:function(type){return _.isUndefined(this.blockCounts[type])?0:this.blockCounts[type]},_canAddBlockType:function(type){var block_type_limit=this._getBlockTypeLimit(type);return!(0!==block_type_limit&&this._getBlockTypeCount(type)>block_type_limit)},_blockLimitReached:function(){return 0!==this.options.blockLimit&&this.blocks.length>=this.options.blockLimit},removeBlock:function(block_id,type){this.blockCounts[type]=this.blockCounts[type]-1,this.blocks=_.reject(this.blocks,function(item){return item.blockID==block_id}),SirTrevor.EventBus.trigger("editor/block/removeBlock")},performValidations:function(block,should_validate){var errors=0;return block._beforeValidate(),!SirTrevor.SKIP_VALIDATION&&should_validate&&(block.validate()||(this.errors.push({text:_.result(block,"validationFailMsg")}),SirTrevor.log("Block "+block.blockID+" failed validation"),++errors)),errors},saveBlockStateToStore:function(block){var store=block.save();_.isEmpty(store.data)||(SirTrevor.log("Adding data for block "+block.blockID+" to block store"),this.store("add",this,{data:store}))},onFormSubmit:function(should_validate){return should_validate=should_validate===!1?!1:!0,SirTrevor.log("Handling form submission for Editor "+this.ID),this.removeErrors(),this.store("reset",this),this.validateBlocks(should_validate),this.validateBlockTypesExist(should_validate),this.renderErrors(),this.store("save",this),this.errors.length},validateBlocks:function(should_validate){if(!this.required&&SirTrevor.SKIP_VALIDATION&&!should_validate)return!1;var blockIterator=function(block){var _block=_.find(this.blocks,function(b){return b.blockID==$(block).attr("id")});return _.isUndefined(_block)?!1:(this.performValidations(_block,should_validate),this.saveBlockStateToStore(_block),void 0)};_.each(this.$wrapper.find(".st-block"),_.bind(blockIterator,this))},validateBlockTypesExist:function(should_validate){if(!this.required&&SirTrevor.SKIP_VALIDATION&&!should_validate)return!1;var blockTypeIterator=function(type){if(this._isBlockTypeAvailable(type))if(0===this._getBlockTypeCount(type))SirTrevor.log("Failed validation on required block type "+type),this.errors.push({text:"You must have a block of type "+type});else{var blocks=_.filter(this.blocks,function(b){return b.type==type&&!_.isEmpty(b.getData())});if(blocks.length>0)return!1;this.errors.push({text:"A required block type "+type+" is empty"}),SirTrevor.log("A required block type "+type+" is empty")}};_.each(this.required,_.bind(blockTypeIterator,this))},renderErrors:function(){if(0===this.errors.length)return!1;_.isUndefined(this.$errors)&&(this.$errors=$("<div>",{"class":"st-errors",html:"<p>You have the following errors: </p><ul></ul>"}),this.$outer.prepend(this.$errors));var str="";_.each(this.errors,function(error){str+='<li class="st-errors__msg">'+error.text+"</li>"}),this.$errors.find("ul").append(str),this.$errors.show()},removeErrors:function(){return 0===this.errors.length?!1:(this.$errors.hide().find("ul").html(""),this.errors=[],void 0)},findBlockById:function(block_id){return _.find(this.blocks,function(b){return b.blockID==block_id})},_getBlockTypeLimit:function(t){return this._isBlockTypeAvailable(t)?parseInt(_.isUndefined(this.options.blockTypeLimits[t])?0:this.options.blockTypeLimits[t],10):0},_isBlockTypeAvailable:function(t){return!_.isUndefined(this.blockTypes[t])},_ensureAndSetElements:function(){if(_.isUndefined(this.options.el)||_.isEmpty(this.options.el))return SirTrevor.log("You must provide an el"),!1;this.$el=this.options.el,this.el=this.options.el[0],this.$form=this.$el.parents("form");var $outer=$("<div>").attr({id:this.ID,"class":"st-outer",dropzone:"copy link move"}),$wrapper=$("<div>").attr({"class":"st-blocks"});return this.$el.wrap($outer).wrap($wrapper),this.$outer=this.$form.find("#"+this.ID),this.$wrapper=this.$outer.find(".st-blocks"),!0},_setBlocksTypes:function(){this.blockTypes=_.flattern(_.isUndefined(this.options.blockTypes)?SirTrevor.Blocks:this.options.blockTypes)},_setRequired:function(){this.required=_.isArray(this.options.required)&&!_.isEmpty(this.options.required)?this.options.required:!1}}),SirTrevor.setDefaults=function(options){SirTrevor.DEFAULTS=_.extend(SirTrevor.DEFAULTS,options||{})},SirTrevor.bindFormSubmit=function(form){formBound||(SirTrevor.submittable(),form.bind("submit",this.onFormSubmit),formBound=!0)},SirTrevor.onBeforeSubmit=function(should_validate){var errors=0;return _.each(SirTrevor.instances,function(inst){errors+=inst.onFormSubmit(should_validate)}),SirTrevor.log("Total errors: "+errors),errors},SirTrevor.onFormSubmit=function(ev){var errors=SirTrevor.onBeforeSubmit();errors>0&&(SirTrevor.EventBus.trigger("onError"),ev.preventDefault())},SirTrevor.runOnAllInstances=function(method){_.has(SirTrevor.Editor.prototype,method)?([].unshift.call(arguments,SirTrevor.instances),_.invoke.apply(_,arguments)):SirTrevor.log("method doesn't exist")}})(jQuery,_);